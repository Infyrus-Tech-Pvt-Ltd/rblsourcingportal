{% extends "index.html" %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 py-8">
  <div class="max-w-7xl mx-auto px-6">

    <!-- Header Section -->
    <div class="mb-8">
      <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
        <div>
          <h1 class="text-4xl font-bold text-gray-900 m  async function loadInquiries(page = 1) {
    inquiryTableBody.innerHTML = "";
    paginationDiv.innerHTML = "";
    currentPage = page;

    try {
      let url = `/api/inquiries?page=${page}&perPage=${perPage}`;
      if (searchQuery) {
        url += `&search=${encodeURIComponent(searchQuery)}`;
      }
      
      const response = await fetch(url);
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      const data = await response.json();y Management</h1>
          <p class="text-gray-600">Track and manage customer product inquiries</p>
        </div>
        
        <!-- Stats Cards -->
        <div class="grid grid-cols-2 lg:grid-cols-3 gap-4 lg:gap-6">
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 text-center">
            <div class="text-2xl font-bold text-blue-600" id="totalInquiries">0</div>
            <div class="text-sm text-gray-500">Total</div>
          </div>
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 text-center">
            <div class="text-2xl font-bold text-green-600" id="activeInquiries">0</div>
            <div class="text-sm text-gray-500">Active</div>
          </div>
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 text-center">
            <div class="text-2xl font-bold text-orange-600" id="closedInquiries">0</div>
            <div class="text-sm text-gray-500">Closed</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Search and Actions Bar -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-8">
      <div class="flex flex-col md:flex-row gap-4 items-center justify-between">
        <!-- Search and Filter Section -->
        <div class="flex-1 flex gap-4 max-w-2xl">
          <!-- Search Input -->
          <div class="flex-1">
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
              </div>
              <input 
                type="text" 
                id="searchInput"
                placeholder="Search inquiries..." 
                class="block w-full pl-10 pr-3 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
              >
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex gap-3">
          <button 
            onclick="clearSearch()" 
            class="inline-flex items-center px-4 py-3 border border-gray-200 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors"
          >
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            Refresh
          </button>
          <button 
            onclick="toggleForm()" 
            class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white text-sm font-medium rounded-lg hover:from-blue-700 hover:to-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 shadow-sm transition-all"
          >
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
            Add Inquiry
          </button>
        </div>
      </div>
    </div>

    <!-- Add Inquiry Form -->
    <div id="addInquiryForm" class="hidden bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden mb-8">
      
      <!-- Form Header -->
      <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-b border-gray-200 p-6">
        <div class="flex items-center">
          <div class="h-12 w-12 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-lg flex items-center justify-center mr-4">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
          </div>
          <div>
            <h2 id="formTitle" class="text-xl font-bold text-gray-900">Create New Inquiry</h2>
            <p class="text-sm text-gray-600">Fill in the details for the customer inquiry</p>
          </div>
        </div>
      </div>

      <!-- Form Body -->
      <div class="p-8">
        <form id="inquiryForm" class="space-y-6">
          <!-- Form Fields -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label for="customer_id" class="block text-sm font-medium text-gray-700 mb-2">
                Customer <span class="text-red-500">*</span>
              </label>
              <select id="customer_id" required
                      class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="" disabled selected>Select Customer</option>
              </select>
            </div>
            <div>
              <label for="product_id" class="block text-sm font-medium text-gray-700 mb-2">
                Product <span class="text-red-500">*</span>
              </label>
              <select id="product_id" required
                      class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="" disabled selected>Select Product</option>
              </select>
            </div>
            <div>
              <label for="quantity" class="block text-sm font-medium text-gray-700 mb-2">
                Quantity <span class="text-red-500">*</span>
              </label>
              <input type="number" min="1" id="quantity" required disabled
                     class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:bg-gray-50 disabled:text-gray-500"
                     placeholder="Select product first" />
            </div>
            <div>
              <label for="amount" class="block text-sm font-medium text-gray-700 mb-2">
                Amount (Rs.)
              </label>
              <input type="number" min="0" step="0.01" id="amount"
                     class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                     placeholder="Auto-calculated" />
            </div>
            <div>
              <label for="status" class="block text-sm font-medium text-gray-700 mb-2">
                Status <span class="text-red-500">*</span>
              </label>
              <select id="status" required
                      class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="" disabled selected>Select Status</option>
                <option value="Inquiry">Inquiry</option>
                <option value="Quoting">Quoting</option>
                <option value="Quotation Accepted">Quotation Accepted</option>
                <option value="Payment Received">Payment Received</option>
                <option value="Order Placed">Order Placed</option>
                <option value="Inshiping">Inshiping</option>
                <option value="Arrived Kathmandu">Arrived Kathmandu</option>
                <option value="Delivered">Delivered</option>
                <option value="Closed">Closed</option>
              </select>
            </div>
            <div>
              <label for="remarks" class="block text-sm font-medium text-gray-700 mb-2">
                Additional Remarks
              </label>
              <input type="text" id="remarks"
                     class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                     placeholder="Additional notes or requirements" />
            </div>
          </div>

          <!-- Form Actions -->
          <div class="flex justify-end gap-4 pt-6 border-t border-gray-200">
            <button type="button" onclick="toggleForm()"
                    class="px-6 py-3 border border-gray-200 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium">
              Cancel
            </button>
            <button type="submit"
                    class="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white px-6 py-3 rounded-lg shadow-sm transition-all duration-200 font-medium flex items-center" 
                    id="submitBtn">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
              Save Inquiry
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Inquiry Table -->
    <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
      
      <!-- Table Header -->
      <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-b border-gray-200 p-6">
        <div class="flex items-center">
          <div class="h-12 w-12 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-lg flex items-center justify-center mr-4">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
            </svg>
          </div>
          <div>
            <h2 class="text-xl font-bold text-gray-900">All Inquiries</h2>
            <p class="text-sm text-gray-600">Track and manage customer product inquiries</p>
          </div>
        </div>
      </div>

      <!-- Inquiry Table -->
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200" id="inquiryTable">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-4 text-xs font-medium text-gray-500 uppercase tracking-wider text-left">
                <div class="flex items-center">
                  <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a.997.997 0 01-1.414 0l-7-7A2 2 0 013 12V7a2 2 0 012-2z"></path>
                  </svg>
                  Inquiry No
                </div>
              </th>
              <th class="px-6 py-4 text-xs font-medium text-gray-500 uppercase tracking-wider text-left">
                <div class="flex items-center">
                  <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                  </svg>
                  Customer
                </div>
              </th>
              <th class="px-6 py-4 text-xs font-medium text-gray-500 uppercase tracking-wider text-left">
                <div class="flex items-center">
                  <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                  </svg>
                  Product
                </div>
              </th>
              <th class="px-6 py-4 text-xs font-medium text-gray-500 uppercase tracking-wider text-left">
                <div class="flex items-center">
                  <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"></path>
                  </svg>
                  Quantity
                </div>
              </th>
              <th class="px-6 py-4 text-xs font-medium text-gray-500 uppercase tracking-wider text-left">
                <div class="flex items-center">
                  <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                  </svg>
                  Amount
                </div>
              </th>
              <th class="px-6 py-4 text-xs font-medium text-gray-500 uppercase tracking-wider text-left">
                <div class="flex items-center">
                  <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  Status
                </div>
              </th>
              <th class="px-6 py-4 text-xs font-medium text-gray-500 uppercase tracking-wider text-center">
                <div class="flex items-center justify-center">
                  <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"></path>
                  </svg>
                  Actions
                </div>
              </th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </div>

    <!-- Pagination -->
    <div id="pagination" class="mt-6 flex justify-center space-x-2"></div>
  </div>

  <!-- Customer History Modal -->
  <div id="customerModal"
       class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50" aria-modal="true" role="dialog" aria-labelledby="modalTitle" aria-describedby="modalDesc">
    <div class="bg-white p-6 rounded-lg shadow-lg max-w-2xl w-full max-h-[80vh] overflow-y-auto" role="document">
      <div class="flex justify-between items-center mb-4">
        <h3 id="modalTitle" class="text-xl font-semibold text-gray-800">Customer Purchase History</h3>
        <button onclick="closeCustomerModal()"
                aria-label="Close modal"
                class="text-gray-500 hover:text-gray-700 text-2xl leading-none font-bold">&times;</button>
      </div>
      <div id="customerHistory" class="text-gray-700" aria-describedby="modalDesc"></div>
    </div>
  </div>

</div>

<script>
  let currentPage = 1;
  const perPage = 7;
  let totalPages = 1;
  let editingInquiryId = null;
  let searchQuery = "";
  let searchTimeout = null;
  let currentInquiries = []; // Store current inquiries for delete function

  function toggleForm() {
    const form = document.getElementById("addInquiryForm");
    form.classList.toggle("hidden");

    const title = document.getElementById("formTitle");
    const submitBtn = document.getElementById("submitBtn");

    if (!form.classList.contains("hidden")) {
      document.getElementById("inquiryForm").reset();
      editingInquiryId = null;
      title.textContent = "Create New Inquiry";
      submitBtn.textContent = "Save Inquiry";
      resetForm(); // Reset form state and disable fields
      form.scrollIntoView({behavior: "smooth"});
    }
  }

  function closeCustomerModal() {
    document.getElementById("customerModal").classList.add("hidden");
  }

  function clearSearch() {
    document.getElementById("searchInput").value = "";
    searchQuery = "";
    currentPage = 1;
    loadInquiries();
  }

  function performSearch() {
    searchQuery = document.getElementById("searchInput").value.trim();
    currentPage = 1;
    loadInquiries();
  }

  function resetForm() {
    // Disable quantity and amount until product is selected
    quantityInput.disabled = true;
    quantityInput.value = "";
    amountInput.value = "";
    quantityInput.placeholder = "Select product first";
    amountInput.placeholder = "Auto-calculated";
  }

  function enableQuantityAndCalculateAmount() {
    const selectedProductId = productSelect.value;
    if (!selectedProductId) {
      resetForm();
      return;
    }

    // Find selected product data
    const selectedProduct = productsData.find(p => p.id === selectedProductId);
    if (!selectedProduct) {
      console.error("Product not found:", selectedProductId);
      resetForm();
      return;
    }

    console.log("Selected product:", selectedProduct);

    // Enable quantity field and set default
    quantityInput.disabled = false;
    quantityInput.value = 1;
    quantityInput.placeholder = "";
    
    // Calculate and set amount
    calculateAmount();
  }

  function calculateAmount() {
    const selectedProductId = productSelect.value;
    const quantity = parseInt(quantityInput.value) || 1;
    
    if (!selectedProductId) return;

    const selectedProduct = productsData.find(p => p.id === selectedProductId);
    if (!selectedProduct) {
      console.error("Product not found for calculation:", selectedProductId);
      return;
    }

    const price = parseFloat(selectedProduct.price) || 0;
    const totalAmount = price * quantity;
    
    console.log(`Calculation: ${price} x ${quantity} = ${totalAmount}`);
    
    amountInput.value = totalAmount.toFixed(2);
    amountInput.placeholder = "";
  }

  const customerSelect = document.getElementById("customer_id");
  const productSelect = document.getElementById("product_id");
  const statusSelect = document.getElementById("status");
  const quantityInput = document.getElementById("quantity");
  const amountInput = document.getElementById("amount");
  const inquiryTableBody = document.querySelector("#inquiryTable tbody");
  const paginationDiv = document.getElementById("pagination");
  
  // Store product data for price calculations
  let productsData = [];

  async function loadDropdowns() {
    try {
      const [customers, products] = await Promise.all([
        fetch("/api/customers").then(r => r.json()),
        fetch("/api/products").then(r => r.json()),
      ]);

      // Store products data for price calculations
      productsData = products;
      console.log("Loaded products with prices:", productsData);

      // Clear existing options except the first placeholder
      customerSelect.length = 1;
      productSelect.length = 1;

      customers.forEach(c => {
        const option = document.createElement("option");
        option.value = c.id;
        option.textContent = c.name;
        customerSelect.appendChild(option);
      });

      products.forEach(p => {
        const option = document.createElement("option");
        option.value = p.id;
        option.textContent = `${p.name} - Rs ${(p.price || 0).toFixed(2)}`;
        option.setAttribute('data-price', p.price || 0);
        productSelect.appendChild(option);
      });

      // Initially disable quantity and amount fields
      resetForm();

    } catch (e) {
      console.error("Failed to load dropdowns", e);
      alert("Failed to load customers or products. Check console.");
    }
  }

  async function loadInquiries(page = 1) {
    inquiryTableBody.innerHTML = "";
    paginationDiv.innerHTML = "";
    currentPage = page;

    try {
      let url = `/api/inquiries?page=${page}&perPage=${perPage}`;
      if (searchQuery) {
        url += `&search=${encodeURIComponent(searchQuery)}`;
      }
      
      const response = await fetch(url);
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      const data = await response.json();

      const inquiries = data.items || [];
      currentInquiries = inquiries; // Store for delete function
      totalPages = data.totalPages || 1;

      // Update stats from API
      if (data.stats) {
        document.getElementById("totalInquiries").textContent = data.stats.total;
        document.getElementById("activeInquiries").textContent = data.stats.active;
        document.getElementById("closedInquiries").textContent = data.stats.closed;
      }

      if (inquiries.length === 0) {
        let message = "No inquiries found";
        if (searchQuery && statusFilter) {
          message += ` matching "${searchQuery}" with status "${statusFilter}".`;
        } else if (searchQuery) {
          message += ` matching "${searchQuery}".`;
        } else if (statusFilter) {
          message += ` with status "${statusFilter}".`;
        } else {
          message += ".";
        }
        
        inquiryTableBody.innerHTML = `
          <tr>
            <td colspan="7" class="text-center text-gray-400 py-6">${message}</td>
          </tr>`;
        return;
      }

      inquiries.forEach(inq => {
        // Define status colors
        const getStatusColor = (status) => {
          switch(status) {
            case 'Inquiry': return 'bg-gray-100 text-gray-800';
            case 'Quoting': return 'bg-yellow-100 text-yellow-800';
            case 'Quotation Accepted': return 'bg-blue-100 text-blue-800';
            case 'Payment Received': return 'bg-green-100 text-green-800';
            case 'Order Placed': return 'bg-purple-100 text-purple-800';
            case 'Inshiping': return 'bg-indigo-100 text-indigo-800';
            case 'Arrived Kathmandu': return 'bg-orange-100 text-orange-800';
            case 'Delivered': return 'bg-emerald-100 text-emerald-800';
            case 'Closed': return 'bg-slate-100 text-slate-800';
            default: return 'bg-gray-100 text-gray-800';
          }
        };

        inquiryTableBody.innerHTML += `
          <tr class="hover:bg-gray-50 transition-colors">
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                ${inq.inquiry_no}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
              <a href="/customers/${inq.customer_id}" class="text-blue-600 hover:underline">${inq.customer_name}</a>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
              <a href="/product/${inq.product_id}" class="text-blue-600 hover:underline">${inq.product_name}</a>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${inq.quantity}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
              ${inq.amount !== null && inq.amount !== undefined && inq.amount !== '' ? 'Rs ' + parseFloat(inq.amount).toFixed(2) : 'Rs 0.00'}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusColor(inq.status)}">
                ${inq.status}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-center">
              <div class="flex items-center justify-center space-x-2">
                <button 
                  onclick="editInquiry('${inq.id}')" 
                  class="inline-flex items-center p-2 border border-transparent rounded-md text-blue-600 hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors"
                  title="Edit Inquiry"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                  </svg>
                </button>
                <button 
                  onclick="deleteInquiry('${inq.id}')" 
                  class="inline-flex items-center p-2 border border-transparent rounded-md text-red-600 hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors"
                  title="Delete Inquiry"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                  </svg>
                </button>
              </div>
            </td>
          </tr>
        `;
      });

      // Pagination with « Prev 1 2 Next » format
      if (totalPages > 1) {
        let paginationHtml = `
          <div class="mt-8 flex items-center justify-center">
            <div class="flex items-center space-x-1">
        `;

        // Previous button
        if (currentPage > 1) {
          paginationHtml += `
            <button onclick="changePage(${currentPage - 1})" class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
              « Prev
            </button>
          `;
        } else {
          paginationHtml += `
            <span class="px-3 py-2 text-sm font-medium text-gray-300 bg-gray-100 border border-gray-300 rounded-md cursor-not-allowed">
              « Prev
            </span>
          `;
        }

        // Page numbers
        for (let p = 1; p <= totalPages; p++) {
          if (p === currentPage) {
            paginationHtml += `
              <span class="px-3 py-2 text-sm font-medium text-white bg-blue-600 border border-blue-600 rounded-md">
                ${p}
              </span>
            `;
          } else {
            paginationHtml += `
              <button onclick="changePage(${p})" class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                ${p}
              </button>
            `;
          }
        }

        // Next button
        if (currentPage < totalPages) {
          paginationHtml += `
            <button onclick="changePage(${currentPage + 1})" class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
              Next »
            </button>
          `;
        } else {
          paginationHtml += `
            <span class="px-3 py-2 text-sm font-medium text-gray-300 bg-gray-100 border border-gray-300 rounded-md cursor-not-allowed">
              Next »
            </span>
          `;
        }

        paginationHtml += `
            </div>
          </div>
        `;

        paginationDiv.innerHTML = paginationHtml;
      }
    } catch (e) {
      console.error("Failed to load inquiries", e);
      inquiryTableBody.innerHTML = `
        <tr>
          <td colspan="7" class="text-center text-red-500 py-6">No inquiries found.</td>
        </tr>`;
    }
  }

  function changePage(newPage) {
    if(newPage < 1 || newPage > totalPages) return;
    loadInquiries(newPage);
  }

  async function showCustomerHistory(customerId) {
    try {
      const data = await fetch(`/api/customers/${customerId}/history`).then(r => r.json());
      if (data.error) throw new Error(data.error);

      let html = `<h5 class="font-bold mb-2">${data.customer.name}</h5><ul class="list-disc list-inside">`;
      data.purchases.forEach(p => {
        html += `<li>${p.product_name} - Qty: ${p.quantity}, Date: ${new Date(p.date).toLocaleDateString()}</li>`;
      });
      html += "</ul>";

      document.getElementById("customerHistory").innerHTML = html;
      document.getElementById("customerModal").classList.remove("hidden");
    } catch (e) {
      console.error("Failed to load customer details", e);
      alert("Failed to load customer details.");
    }
  }

  async function deleteInquiry(id) {
    const inquiry = currentInquiries.find(inq => inq.id === id);
    const inquiryName = inquiry ? `${inquiry.customer_name} - ${inquiry.product_name}` : 'this inquiry';
    
    showConfirmationModal({
      title: 'Delete Inquiry',
      message: `Are you sure you want to delete inquiry for ${inquiryName}?`,
      confirmText: 'Delete Inquiry',
      callback: async () => {
        try {
          const res = await fetch(`/api/inquiries/${id}`, { method: "DELETE" });
          if (!res.ok) throw new Error(await res.text());
          loadInquiries(currentPage);
        } catch (e) {
          alert("Failed to delete inquiry: " + e.message);
        }
      }
    });
  }

  async function editInquiry(id) {
    editingInquiryId = id;
    try {
      // Fetch single inquiry by filtering inquiries or via API endpoint if available
      const res = await fetch(`/api/inquiries?page=1&perPage=1000`); // big perPage for demo
      if (!res.ok) throw new Error("Failed to fetch inquiry data");

      const data = await res.json();
      const inquiry = data.items.find(i => i.id === id);
      if (!inquiry) throw new Error("Inquiry not found");

      // Fill form with inquiry data
      customerSelect.value = inquiry.customer_id;
      productSelect.value = inquiry.product_id;
      
      // Enable fields for editing
      quantityInput.disabled = false;
      quantityInput.placeholder = "";
      amountInput.placeholder = "";
      
      document.getElementById("quantity").value = inquiry.quantity;
      document.getElementById("amount").value = inquiry.amount || "";
      statusSelect.value = inquiry.status || "Inquiry";
      document.getElementById("remarks").value = inquiry.remarks || "";

      // Show form with 'Edit' title and button text
      const form = document.getElementById("addInquiryForm");
      if (form.classList.contains("hidden")) {
        form.classList.remove("hidden");
      }
      document.getElementById("formTitle").textContent = "Edit Inquiry";
      document.getElementById("submitBtn").textContent = "Update Inquiry";

      form.scrollIntoView({behavior: "smooth"});
    } catch (e) {
      alert("Failed to load inquiry for editing: " + e.message);
    }
  }

  document.getElementById("inquiryForm").addEventListener("submit", async e => {
    e.preventDefault();

    const customerId = customerSelect.value;
    const productId = productSelect.value;
    const status = statusSelect.value;
    
    if (!customerId || !productId || !status) {
      alert("Please select customer, product, and status.");
      return;
    }

    const quantity = parseInt(document.getElementById("quantity").value);
    if (isNaN(quantity) || quantity < 1) {
      alert("Quantity must be a positive integer.");
      return;
    }

    const amount = document.getElementById("amount").value;
    const remarks = document.getElementById("remarks").value;

    const payload = {
      customer_id: customerId,
      product_id: productId,
      quantity,
      amount,
      status,
      remarks
    };

    try {
      let res;
      if (editingInquiryId) {
        // Update existing inquiry
        res = await fetch(`/api/inquiries/${editingInquiryId}`, {
          method: "PUT",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify(payload)
        });
      } else {
        // Create new inquiry
        res = await fetch("/api/inquiries", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify(payload)
        });
      }

      if (!res.ok) {
        const errorText = await res.text();
        throw new Error(errorText);
      }

      e.target.reset();
      toggleForm();
      editingInquiryId = null;
      loadInquiries(currentPage);
    } catch (err) {
      alert("Failed to save inquiry: " + err.message);
    }
  });

  // Initial load
  loadDropdowns();
  loadInquiries();

  // Product selection event listener
  productSelect.addEventListener("change", function() {
    enableQuantityAndCalculateAmount();
  });

  // Quantity change event listener
  quantityInput.addEventListener("input", function() {
    if (!productSelect.value) {
      this.value = "";
      return;
    }
    calculateAmount();
  });

  // Search functionality
  document.getElementById("searchInput").addEventListener("input", function(e) {
    // Clear previous timeout
    if (searchTimeout) {
      clearTimeout(searchTimeout);
    }
    
    // Set new timeout for debounced search
    searchTimeout = setTimeout(() => {
      performSearch();
    }, 500); // Wait 500ms after user stops typing
  });

  // Handle Enter key in search
  document.getElementById("searchInput").addEventListener("keypress", function(e) {
    if (e.key === "Enter") {
      e.preventDefault();
      performSearch();
    }
  });

</script>
{% endblock %}